{% extends 'base.html.twig' %}
{% block title %}Расписание{% endblock %}
{% block router %}cabinet{% endblock %}
{% block css %}
  {% for style in styles %}
    <link type="text/css" rel="stylesheet" href="/assets/styles/{{ style }}" />
  {% endfor %}
{% endblock %}
{% block body %}
<div class="cabinet" id="cabinet2" style="min-height: 40vw">
  <div class="container">
    <div class="header">
      <div class="lft">
        <a class="active">РАСПИСАНИЕ</a>
        <a href="{{ path('timetable_index') }}">КАЛЕНДАРЬ</a>
        <a href="{{ path('purse_index') }}">КОШЕЛЕК</a>
        <a href="{{ path('trainer_settings_index') }}">НАСТРОЙКИ</a>
      </div>
      <div class="rgt">
        <a href="{{ path('app_logout') }}">Выйти</a>
      </div>
    </div>
    <div class="list">
      <div class="lft">
        <div class="list-table" v-for="(item, i) in items" :key="i">
          <div class="date" v-text="item.parse"></div>
          <div class="item" v-for="(child, i2) in item.items" :key="i2">
            <div class="time" v-text="child.time"></div>
            <div class="user">
              <img :src="child.icon"  />
              <span v-text="child.nik" />
            </div>
            <div class="button h" @click="setSelect(child)">Подробнее</div>
            <div class="button h" @click="setStatus(child)" v-if="!child.trainerStatus">Занятие окончено</div>
            <div class="button w" v-if="child.trainerStatus">ожидаем подтверждения учеником</div>
          </div>
        </div>
      </div>
      <transition name="slide-fade">
        <div class="rgt" v-if="data !== null">
          <div class="top">
            <img :src="data.icon" />
            <div class="data">
              <div class="name" v-text="data.nik"></div>
              <div class="online" v-text="data.online"></div>
              <div class="date" v-text="data.date"></div>
              <div class="time" v-text="data.time"></div>
            </div>
          </div>
          <a :href="data.discord" class="button discord" v-if="data.discord" target="_blank">
            <img src="/images/discord.svg" alt="discord" />Перейти в Discord
          </a>
          <div class="button steam" style="display: none">
            <img src="/images/steam.svg" alt="steam" />Перейти в Steam
          </div>
          <div class="rows-info">
            <div class="r">
              <div class="name">ИМЯ</div>
              <div class="text" v-text="data.fullname"></div>
            </div>
            <div class="r">
              <div class="name">РАНГ ИГРОКА</div>
              <div class="text" v-text="data.rank"></div>
            </div>
            <div class="r">
              <div class="name">ТРЕНИРОВОК ВСЕГО</div>
              <div class="text" v-text="data.trainingAll"></div>
            </div>
            <div class="r">
              <div class="name">ТРЕНИРОВОК СО МНОЙ</div>
              <div class="text" v-text="data.training"></div>
            </div>
          </div>
          <div class="charaster" style="display: none">
            <a>Смотреть характеристику <img src="/images/arrowLineRgtOrange.svg" alt="arrowLineRgtOrange" /></a>
          </div>
          <div class="profile" style="display: none">Заполнена на 83%</div>
          <div class="price">
            <div>Стоимость</div>
            <div><span v-text="data.price">1000</span>₽</div>
          </div>
          <div class="end closed" v-if="data.status === 1">Занятие окончено</div>
        </div>
      </transition>
    </div>
  </div>
</div>

<script>
  const cabinet2 = new Vue({
    el: '#cabinet2',
    methods: {
      setSelect(item) {
        const th = this;
        this.data = null;
        this.data = item;
        axios.get(`/ru/lessons/count/{"student_id":"${item.studentId}","trainer_id":"${item.trainerId}"}`)
        .then((res) => {
          if (res.data.trainer && res.data.together) {
            th.data.trainingAll = res.data.trainer;
            th.data.training = res.data.together;
          }
        })
      },
      setStatus(item) {
        const th = this;
        const form = new FormData();
        form.append('user_id', {{ app.user.id }});
        form.append('lesson_id', item.id);
        axios.get(`/ru/lessons/set-status-ended/{"user_id":"{{ app.user.id }}","lesson_id":"${item.id}","istrainer":true}`)
        .then((res) => {
          if (res.data.id) {
            th.setParse();
          }
        })
      },
      setParse() {
        const th = this;
        axios.get('/ru/lessons/trainer/{{ app.user.id }}')
        .then((res) => {
          if (res.data !== null) {
            console.log(res.data)
            let items = [];
            let bool = true;
            res.data.forEach((item, i) => {
              if (item.status === 0) {
                const date = new Date(item.datetime);
                const dateHour = new Date(item.datetime);
                dateHour.setHours(dateHour.getHours() + 1);
                bool = true;
                let newitem = {
                  id: item.id,
                  time: `${date.getHours()}:00 - ${dateHour.getHours() < 10 ? '0' + dateHour.getHours() : dateHour.getHours()}:00`,
                  nik: item.student.nickname,
                  icon: item.student.photo ? '/images/temp/matches/' + item.student.photo : '/uploads/images/830f223afcf85dd280790e27079814b4.jpg',
                  status: item.status,
                  price: item.cost,
                  online: '2 часа назад',
                  discord: item.student.discord,
                  steam: '',
                  trainingAll: '-',
                  training: '-',
                  date: date.toLocaleString("ru", {weekday: 'long', day: 'numeric', month: 'long'}),
                  rank: item.student.rank,
                  fullname: `${item.student.name} ${item.student.family}`,
                  price: item.cost,
                  studentId: item.student.id,
                  trainerId: item.trainer.id,
                  trainerStatus: item.trainerStatus,
                };
                items.forEach((item2, i2) => {
                  const date2 = new Date(item2.date);
                  if (date.getDate() === date2.getDate() && date.getMonth() === date2.getMonth() && date.getFullYear() === date2.getFullYear()) {
                    bool = false;
                    newitem = {
                      id: item.id,
                      time: `${date.getHours()}:00 - ${dateHour.getHours() < 10 ? '0' + dateHour.getHours() : dateHour.getHours()}:00`,
                      nik: item.student.nickname,
                      icon: item.student.photo ? '/images/temp/matches/' + item.student.photo : '/uploads/images/830f223afcf85dd280790e27079814b4.jpg',
                      status: item.status,
                      price: item.cost,
                      online: '2 часа назад',
                      discord: item.student.discord,
                      steam: '',
                      trainingAll: '-',
                      training: '-',
                      date: date.toLocaleString("ru", {weekday: 'long', day: 'numeric', month: 'long'}),
                      rank: item.trainer.rank,
                      fullname: `${item.trainer.name} ${item.trainer.family}`,
                      price: item.cost,
                      studentId: item.student.id,
                      trainerId: item.trainer.id,
                      trainerStatus: item.trainerStatus,
                    };
                    items[i2].items.push(newitem);
                  }
                })
                if (bool) {
                  const nitem = {
                    parse: date.toLocaleString("ru", {weekday: 'long', day: 'numeric', month: 'long'}),
                    date: item.datetime,
                    items: [newitem],
                  };
                  items.push(nitem);
                }
              }
            });
            th.items = items;
          }
        })
      }
    },
    data: function () {
      return {
        data: null,
        items: [],
      }
    },
    mounted() {
      this.setParse();
    },
  });
</script>

{% endblock %}
