{% extends 'base.html.twig' %}
{% block title %}Новости{% endblock %}
{% block router %}news{% endblock %}
{% block description %}
    <meta name="description" content="Новости, статьи, матчи и трансферы по League of Legends, Dota, Cs:go">
{% endblock %}
{% block keywords %}
    <meta name="Keywords" content="Игровые матчи, Игровые новости, События, Видео, Интервью">
{% endblock %}
{% block css %}
    <link type="text/css" rel="stylesheet" href="/assets/styles/load.css" />
{% endblock %}
{% block body %}
    <h1 style="opacity: 0; position: absolute; left: 0; top: 0">
        Новости
    </h1>

    <div class="home" id="home">
        <div class="container">
            <div class="row">
                <div class="col-xl-8 col-lg-8 col-md-8 col-sm-12">
                    {% include 'templates/news/article.html.twig' %}
                </div>
                <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12">
                    {% include 'templates/news/articles.html.twig' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    <script>
        const newsArticle = new Vue({
            el: '#news-article',
            data: {
                news: [],
                load: false,
                isLoadAll: false,
                types: [
                    'Трансфер',
                    'Матч',
                    'Видео',
                    'Интервью',
                    'Статья',
                    'Обновления',
                    'Текст'
                ],
                filters: {
                    tag: null,
                },
                pageEnd: false,
                offset: 0,
            },
            computed: {
                newsOrdered() {
                    const newsArray = [];

                    for (let i = 0; i < Math.ceil(this.news.length / 5); i++) {
                        newsArray[i] = this.news.slice((i * 5), (i * 5) + 5);
                    }
                    const newsArrayOrdered = [];
                    for (let news of newsArray) {
                        let newsItem = [];

                        for (let i = 0; i < news.length; i++) {
                            if (i === 2 || i === 3) {
                                if (!newsItem[2]) {
                                    newsItem[2] = [];
                                }
                                newsItem[2].push(news[i])
                            } else {
                                newsItem.push(news[i])
                            }
                        }
                        newsArrayOrdered.push(newsItem)
                    }
                    return newsArrayOrdered;
                },
            },
            methods: {
                loadImage(e) {
                    let w_t = 0;
                    let h_t = 0;
                    let l = 0;
                    let t = 0;
                    let ratio = 0;
                    if (e.clientWidth > e.clientHeight) {
                        w_t = e.parentNode.clientWidth / e.clientWidth;
                        h_t = e.parentNode.clientWidth / e.clientHeight;
                        ratio = Math.min(w_t, h_t);
                        w_t = Math.ceil(e.clientWidth * ratio);
                        h_t = Math.ceil(e.clientHeight * ratio);
                        if (e.parentNode.clientHeight > h_t) {
                            h_t = e.parentNode.clientHeight / e.clientHeight;
                            ratio = Math.min(w_t, h_t);
                            w_t = Math.ceil(e.clientWidth * ratio);
                            h_t = e.parentNode.clientHeight;
                            l = '-' + (w_t - e.parentNode.clientWidth) / 2;
                        }
                    } else {
                        w_t = e.parentNode.clientHeight / e.clientWidth;
                        h_t = e.parentNode.clientHeight / e.clientHeight;
                        ratio = Math.min(w_t, h_t);
                        w_t = Math.ceil(e.clientWidth * ratio);
                        h_t = e.parentNode.clientHeight;
                        l = 0;
                        if (e.parentNode.clientWidth > w_t) {
                            w_t = e.parentNode.clientWidth / e.clientWidth;
                            h_t = e.parentNode.clientWidth / e.clientHeight;
                            ratio = Math.min(w_t, h_t);
                            w_t = e.parentNode.clientWidth;
                            h_t = Math.ceil(e.clientHeight * ratio);
                        }
                    }
                    if (e.parentNode.clientWidth < w_t) {
                        l = '-' + (w_t - e.parentNode.clientWidth) / 2;
                    }
                    if (e.parentNode.clientHeight < h_t) {
                        t = '-' + (h_t - e.parentNode.clientHeight) / 2;
                    }
                    e.style.left = t + 'px';
                    e.style.left = l + 'px';
                    e.style.width = w_t + 'px';
                    e.style.height = h_t + 'px';
                    e.style.opacity = '1';
                },
                getClass(index) {
                    let className = 'news__image';

                    if (index === 0) {
                        className = 'news__image_cub'
                    }
                    return className;
                },
                getTitle(title) {
                    if (title.length > 70) {
                        return `${title.substr(0, 70)}...`
                    } else {
                        return title;
                    }
                },
                getNews() {
                    if (!this.isLoadAll){
                        this.load = true;
                        this.offset = this.news.length

                        axios.post('{{ url('news.ajax') }}/' + this.news.length, this.filters)
                            .then(({data}) => {
                                if (data.length === 0){
                                    this.isLoadAll = true;
                                }
                                for (let item of data){
                                    const news = this.news.find(news => Number(item.id) === Number(news.id))
                                    if (!news){
                                        this.news.push(item);
                                    }
                                }
                                this.load = false;
                            })
                    }
                },
                scrollEventTrigger(){
                    const self = this;

                    window.onscroll = () => {
                        const scrollable = $("body").height() - ($(window).innerHeight() + $(window).scrollTop());

                        if (scrollable <= 10) {
                            self.getNews()
                        }
                    }
                },
                showByTag(tagTitle){
                    this.filters.tag = tagTitle;
                    this.news = [];
                    this.isLoadAll = false;

                    this.getNews();
                    event.preventDefault()
                }
            },
            mounted() {
                this.getNews();
                this.scrollEventTrigger();
            }
        })
    </script>
{% endblock %}